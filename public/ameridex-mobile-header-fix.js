/**
 * ameridex-mobile-header-fix.js
 *
 * Fixes two mobile overflow problems visible in screenshots:
 *
 * PROBLEM 1 — dealer-portal.html header
 *   The header-actions row has: [STANDARD] [PAT123 | AmeriDex Admin] [My Quotes] [Admin] [Settings] [Logout]
 *   All items are white-space:nowrap on one flex row → right side clips off screen.
 *
 * PROBLEM 2 — Admin Panel modal tab bar
 *   The tab bar has: Dealers | Quotes | Products | Customers | Dealer Pricing | Users
 *   Tabs are wider than the modal → "Dealer Pricing" and "Users" get clipped.
 *
 * SOLUTION:
 *   1. On mobile (≤ 768px) split header-actions into two sub-rows:
 *      ROW A (top):    logo area stays as-is (handled by existing CSS)
 *      ROW B (dealer info line): already full-width
 *      ROW C (nav buttons): wrap into a 3×2 or 2×3 grid using flex-wrap
 *      — No DOM restructure needed, just apply targeted inline styles.
 *
 *   2. Inject a <style> block into <head> with the definitive mobile rules
 *      so they override everything, including inline styles in admin.js.
 *
 *   3. Patch the admin modal tab bar to use overflow-x: auto + scroll-snap
 *      so all tabs are reachable by swiping.
 *
 * Loaded via <script defer> at the bottom of dealer-portal.html.
 * Safe to load on quotes-customers.html too.
 */

(function ameridexMobileHeaderFix() {
  'use strict';

  var MOBILE_BP = 768;

  // ─────────────────────────────────────────────────────────────
  // 1. Inject a <style> block that wins over every existing rule
  //    Scoped inside @media so it has zero effect on desktop.
  // ─────────────────────────────────────────────────────────────
  var css = [
    /* ---- DEALER-PORTAL HEADER ---- */
    '@media (max-width: 768px) {',

    /* Force the outer header to never clip children */
    'header.app-header {',
    '  overflow: visible !important;',
    '  width: 100% !important;',
    '  max-width: 100vw !important;',
    '  box-sizing: border-box !important;',
    '  padding: 0.85rem 1rem !important;',
    '  flex-direction: column !important;',
    '  align-items: stretch !important;',
    '  gap: 0.5rem !important;',
    '}',

    /* Brand row: logo + title on one line */
    '.header-brand {',
    '  flex-direction: row !important;',
    '  align-items: center !important;',
    '  justify-content: flex-start !important;',
    '  gap: 0.65rem !important;',
    '  width: 100% !important;',
    '}',
    'header.app-header img {',
    '  max-width: 100px !important;',
    '  flex-shrink: 0 !important;',
    '}',
    '.header-titles h1 {',
    '  font-size: 1rem !important;',
    '  white-space: nowrap !important;',
    '  overflow: hidden !important;',
    '  text-overflow: ellipsis !important;',
    '  margin: 0 !important;',
    '}',

    /* Actions row: WRAP the buttons, never clip */
    '.header-actions {',
    '  display: flex !important;',
    '  flex-direction: row !important;',
    '  flex-wrap: wrap !important;',
    '  align-items: center !important;',
    '  gap: 0.35rem !important;',
    '  width: 100% !important;',
    '  overflow: visible !important;',
    '}',

    /* Dealer info on its own full-width line */
    '.header-dealer-info {',
    '  width: 100% !important;',
    '  flex-basis: 100% !important;',
    '  order: -1 !important;',
    '  font-size: 0.72rem !important;',
    '  text-align: left !important;',
    '  margin: 0 0 0.1rem !important;',
    '}',

    /* Each nav button: equal-share of row, max 2 per row */
    '.header-btn {',
    '  flex: 1 1 calc(50% - 0.35rem) !important;',
    '  max-width: calc(50% - 0.35rem) !important;',
    '  min-width: 0 !important;',
    '  white-space: nowrap !important;',
    '  overflow: hidden !important;',
    '  text-overflow: ellipsis !important;',
    '  padding: 0.5rem 0.5rem !important;',
    '  font-size: 0.74rem !important;',
    '  min-height: 36px !important;',
    '  text-align: center !important;',
    '  box-sizing: border-box !important;',
    '}',

    /* ---- ADMIN PANEL MODAL TAB BAR ---- */
    /* The tab container generated by ameridex-admin.js */
    '.admin-tabs, [class*="admin-tab"] {',
    '  display: flex !important;',
    '  flex-direction: row !important;',
    '  flex-wrap: nowrap !important;',
    '  overflow-x: auto !important;',
    '  -webkit-overflow-scrolling: touch !important;',
    '  scroll-snap-type: x mandatory !important;',
    '  gap: 0 !important;',
    '  /* hide scrollbar visually on webkit */;',
    '  scrollbar-width: none !important;',
    '}',
    '.admin-tabs::-webkit-scrollbar { display: none !important; }',

    /* Each tab button inside the bar */
    '.admin-tabs button, .admin-tabs a, [class*="admin-tab"] button {',
    '  flex: 0 0 auto !important;',
    '  white-space: nowrap !important;',
    '  scroll-snap-align: start !important;',
    '  min-height: 44px !important;',
    '  padding: 0.6rem 1rem !important;',
    '  font-size: 0.85rem !important;',
    '}',

    /* The admin modal itself must not clip horizontally */
    '.admin-modal, [id*="admin-modal"], [id*="adminModal"] {',
    '  max-width: 100vw !important;',
    '  width: 100% !important;',
    '  overflow-x: hidden !important;',
    '  box-sizing: border-box !important;',
    '}',

    /* Inner content wrapper */
    '.admin-modal-content, .admin-panel-content {',
    '  width: 100% !important;',
    '  max-width: 100% !important;',
    '  overflow-x: hidden !important;',
    '  box-sizing: border-box !important;',
    '}',

    /* Also catch inline-styled tab bars that admin.js may render */
    /* These selectors target the DOM structure seen in screenshots */
    '#admin-panel-modal .tab-bar,',
    '#admin-panel-modal nav,',
    '#adminModal .tab-bar,',
    '.admin-panel .tab-bar {',
    '  display: flex !important;',
    '  flex-wrap: nowrap !important;',
    '  overflow-x: auto !important;',
    '  -webkit-overflow-scrolling: touch !important;',
    '  scrollbar-width: none !important;',
    '}',
    '#admin-panel-modal .tab-bar::-webkit-scrollbar,',
    '#adminModal .tab-bar::-webkit-scrollbar {',
    '  display: none !important;',
    '}',

    '}' /* end @media */
  ].join('\n');

  function injectStyles() {
    var style = document.createElement('style');
    style.setAttribute('id', 'ameridex-mobile-header-overrides');
    style.textContent = css;
    document.head.appendChild(style);
  }

  // ─────────────────────────────────────────────────────────────
  // 2. Runtime JS patch for admin modal tab bar
  //    Runs whenever the admin modal opens (MutationObserver on body)
  //    Handles dynamically-rendered admin HTML from ameridex-admin.js
  // ─────────────────────────────────────────────────────────────
  function patchAdminTabBar(root) {
    if (window.innerWidth > MOBILE_BP) return;
    var tabBar = root.querySelector(
      '.admin-tabs, [class*="admin-tab"], #admin-panel-modal nav, ' +
      '#adminModal nav, .admin-panel nav, [data-admin-tabs]'
    );
    if (!tabBar) return;
    tabBar.style.cssText = [
      'display:flex',
      'flex-direction:row',
      'flex-wrap:nowrap',
      'overflow-x:auto',
      '-webkit-overflow-scrolling:touch',
      'scroll-snap-type:x mandatory',
      'scrollbar-width:none'
    ].join(';');
    // Ensure individual tab buttons are not shrunk
    var tabs = tabBar.querySelectorAll('button, a, li');
    tabs.forEach(function(tab) {
      tab.style.cssText = [
        'flex:0 0 auto',
        'white-space:nowrap',
        'scroll-snap-align:start',
        'min-height:44px',
        'padding:0.6rem 1rem',
        'font-size:0.85rem'
      ].join(';');
    });
  }

  function watchForAdminModal() {
    if (typeof MutationObserver === 'undefined') return;
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(m) {
        m.addedNodes.forEach(function(node) {
          if (node.nodeType !== 1) return;
          // Check if the added node IS the admin modal or CONTAINS it
          var id = (node.id || '').toLowerCase();
          var cls = (node.className || '').toLowerCase();
          if (id.indexOf('admin') > -1 || cls.indexOf('admin') > -1) {
            patchAdminTabBar(node);
          } else {
            // Search within
            var inner = node.querySelector(
              '[id*="admin"], [class*="admin"]'
            );
            if (inner) patchAdminTabBar(inner);
          }
        });
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }

  // ─────────────────────────────────────────────────────────────
  // 3. Bootstrap
  // ─────────────────────────────────────────────────────────────
  function init() {
    injectStyles();
    if (window.innerWidth <= MOBILE_BP) {
      watchForAdminModal();
      // Patch any admin modal that might already be in the DOM
      patchAdminTabBar(document.body);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
