# ============================================================
# AmeriDex Dealer Portal - Render.com Deployment v2.1
# Updated: 2026-03-01
# ============================================================
# This configuration deploys the dealer portal as a single
# Node.js web service with persistent disk storage.
#
# Required Environment Variables (set in Render dashboard):
#   - TOKEN_SECRET (generate with: openssl rand -base64 32)
#   - NODE_ENV (set to 'production')
#   - PORT (auto-set by Render, defaults to 10000)
# ============================================================

services:
  # Main web service
  - type: web
    name: ameridex-dealer-portal
    runtime: node
    plan: starter  # Change to 'standard' for production
    region: oregon  # Change to your preferred region

    # Puppeteer/Chromium note:
    #   @sparticuz/chromium ships a pre-built Chromium binary optimised
    #   for serverless/Render environments. npm install handles everything.
    #   No extra apt-get steps required on Render's Node runtime.
    buildCommand: npm install
    startCommand: npm start

    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: TOKEN_SECRET
        generateValue: true
      - key: MASTER_KEY
        generateValue: true
      - key: DATA_DIR
        value: /opt/render/project/data

      # --------------------------------------------------------
      # Puppeteer / Chromium — required for PDF generation
      # @sparticuz/chromium provides the binary. puppeteer-core
      # must NOT attempt to download its own Chrome binary.
      # --------------------------------------------------------
      - key: PUPPETEER_SKIP_CHROMIUM_DOWNLOAD
        value: "true"
      - key: PUPPETEER_SKIP_DOWNLOAD
        value: "true"

      # PUPPETEER_EXECUTABLE_PATH is intentionally NOT set here.
      # routes/pdf.js calls chromium.executablePath() at runtime
      # which resolves the correct path automatically.
      # Override only if using a system Chrome locally:
      #   PUPPETEER_EXECUTABLE_PATH = /usr/bin/google-chrome-stable

    healthCheckPath: /api/health
    autoDeploy: true

    # Persistent disk for data storage
    disk:
      name: ameridex-data
      mountPath: /opt/render/project/data
      sizeGB: 1

# ============================================================
# Post-Deployment Setup (manual steps in Render dashboard):
# ============================================================
# 1. Verify TOKEN_SECRET is present in Environment tab.
#
# 2. Confirm Puppeteer env vars are set (render.yaml sets these
#    automatically on first deploy/sync):
#      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD = true
#      PUPPETEER_SKIP_DOWNLOAD = true
#
# 3. Test PDF download on a quote — should produce a real .pdf
#    file in the browser downloads folder with no dialog.
#
# 4. If PDF generation returns 500, check Render logs:
#    - Memory error: upgrade from Starter to Standard plan
#      (Chromium uses ~150-200MB per render; Starter has 512MB total)
#    - Binary not found: verify PUPPETEER_SKIP_DOWNLOAD=true is set
# ============================================================

# ============================================================
# File Structure Expected by This Config:
# ============================================================
# /
# ├── package.json
# ├── server.js
# ├── routes/
# │   ├── auth.js
# │   ├── dealers.js
# │   ├── quotes.js
# │   ├── products.js
# │   ├── customers.js
# │   ├── users.js
# │   ├── master.js
# │   ├── pdf.js             (POST /api/pdf/generate — Puppeteer PDF)
# │   ├── admin-dealers.js
# │   ├── admin-quotes.js
# │   ├── admin-pricing.js
# │   ├── admin-users.js
# │   └── admin-customers.js
# ├── middleware/
# │   └── auth.js
# ├── lib/
# │   ├── token.js
# │   ├── password.js
# │   ├── helpers.js
# │   ├── data-init.js
# │   └── backup.js
# ├── data/                (persistent disk mount)
# ├── public/              (static frontend files)
# ├── .env.example
# └── README.md
# ============================================================

# ============================================================
# Scaling & Performance Notes:
# ============================================================
# - Starter plan: 512MB RAM, 0.5 CPU — PDF works, ~300MB headroom
# - Standard plan: 2GB RAM, 1 CPU — recommended for production PDF load
# - Chromium process is closed after every render to free memory
# - For >100 concurrent users, consider migrating to PostgreSQL
# ============================================================

# ============================================================
# Security Checklist:
# ============================================================
# ✓ TOKEN_SECRET is randomly generated and kept secret
# ✓ Passwords are hashed with HMAC-SHA256
# ✓ HTTPS enforced by Render
# ✓ Auth middleware protects all /api/* routes
# ✓ Admin routes require role=admin check
# ✓ PDF endpoint accepts filled HTML from authenticated clients
# ✓ File uploads disabled
# ============================================================

# ============================================================
# Troubleshooting:
# ============================================================
# Issue: PDF returns 500
# → Check Render logs for Chromium errors
# → Verify PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true is set
# → Upgrade to Standard plan if memory errors occur
#
# Issue: Service fails to start
# → Check logs for missing TOKEN_SECRET
# → Verify package.json has "start": "node server.js"
#
# Issue: Data not persisting
# → Confirm disk is mounted at /opt/render/project/data
# → Verify data/ is in .gitignore
# ============================================================
